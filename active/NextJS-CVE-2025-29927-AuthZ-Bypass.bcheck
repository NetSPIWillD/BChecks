# NextJS CVE-2025-29927 Checker
# wdavison 
# 24/03/2025
metadata:
    language: v2-beta
    name: "NextJS CVE-2025-29927 Checker"
    description: "Attempts AuthZ Bypass using x-middleware-subrequest header"
    tags: "passive", "authorization", "cve"
    author: "wdavison@netspi.com"

define:
    remediationMsg = "Upgrade NextJS to latest"
    detailMsg = "An application request which previously failed was re-issued with the \"x-middleware-subrequest: middleware\" header and then succeeded"


given request then
    if {base.response.status_code} matches "(40(3|1))|(30(1|2|7|8))" then
        send request called requestCheck:
            path: {base.request.url.path}
            method: {base.request.method}
            replacing headers:
                "x-middleware-subrequest" : "middleware"

        if {requestCheck.response.status_code} matches "20[0-2]" then
            report issue and continue:
                name: "NextJS CVE-2025-29927 AuthZ Bypass"
                severity: high
                confidence: tentative
                remediation: {remediationMsg}
                detail: {detailMsg}
                
        end if
    end if
